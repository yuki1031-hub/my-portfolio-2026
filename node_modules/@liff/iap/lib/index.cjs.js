"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var r=require("tslib"),e=require("@liff/use"),t=require("@liff/is-api-available"),i=require("@liff/native-bridge"),n=require("@liff/util"),o=require("@liff/consts"),a=require("@liff/store"),c=require("@liff/server-api");function u(e){return r.__awaiter(this,arguments,void 0,(function(e){var t=e.productIds;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,i.call("iap.getPlatformProducts",{productIds:t}).catch((function(r){if(r.code&&r.description)throw n.createLiffError(r.code,r.description);throw n.createLiffError(o.UNKNOWN,"Failed to get platform products",{cause:r})}))];case 1:return[2,r.sent().products]}}))}))}var d=function(e){return r.__awaiter(void 0,[e],void 0,(function(e){var t=e.productId,i=e.orderId;return r.__generator(this,(function(r){switch(r.label){case 0:if(!window.confirm("Proceed with a test in-app purchase?"))throw n.createLiffError("CANCELED","Transaction was canceled.");return[4,c.fetch(c.getEndPoint("iapVirtualConfirm"),{method:"POST",body:JSON.stringify({productId:t,orderId:i})})];case 1:return r.sent(),[2]}}))}))},s=function(e){return r.__awaiter(void 0,[e],void 0,(function(e){var t,c=e.productId,u=e.orderId;return r.__generator(this,(function(r){switch(r.label){case 0:return(null==(t=a.getContext())?void 0:t.isIapSandbox)?[4,d({productId:c,orderId:u})]:[3,2];case 1:case 3:return r.sent(),[2];case 2:return[4,i.call("iap.createPayment",{productId:c,orderId:u}).catch((function(r){if(r.code&&r.description)throw n.createLiffError(r.code,r.description);throw n.createLiffError(o.UNKNOWN,"Failed to get platform products",{cause:r})}))]}}))}))},f=function(e){function a(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(a,e),Object.defineProperty(a.prototype,"name",{get:function(){return"iap"},enumerable:!1,configurable:!0}),a.prototype.install=function(){var e=this;return{getPlatformProducts:function(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){return t.validators.iap(),[2,u.apply(void 0,r.__spreadArray([],r.__read(i),!1))]}))}))},createPayment:function(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){return t.validators.iap(),[2,s.apply(void 0,r.__spreadArray([],r.__read(i),!1))]}))}))},requestConsentAgreement:function(){return r.__awaiter(e,void 0,void 0,(function(){return r.__generator(this,(function(e){return t.validators.iap(),[2,r.__awaiter(void 0,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,i.call("iap.requestConsentAgreement").catch((function(r){if(r.code&&r.description)throw n.createLiffError(r.code,r.description);throw n.createLiffError(o.UNKNOWN,"Failed to request consent agreement",{cause:r})}))];case 1:return r.sent(),[2]}}))}))]}))}))}}},a}(e.LiffModule);exports.IapModule=f;
